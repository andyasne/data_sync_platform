<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Data Transfer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-10"
      x-data
      x-init="$store.events = []"
      x-effect>
    <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-xl">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Data Transfer</h2>
        <form class="flex flex-col gap-4 mb-8"
              hx-post="/transfer/start"
              hx-swap="none">
            <input name="tables"
                   class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                   placeholder="table1,table2">
            <input name="modified_col"
                   class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                   placeholder="modified_col"
                   value="server_modified_date">
            <button class="bg-blue-600 text-white font-semibold rounded px-4 py-2 hover:bg-blue-700 transition">
                Start
            </button>
        </form>

        <h3 class="text-lg font-semibold mb-4 text-gray-700">Progress</h3>
        <template x-for="e in $store.events" :key="e.table">
            <div class="mb-4">
                <div class="flex justify-between mb-1">
                    <span class="font-medium text-gray-800" x-text="e.table"></span>
                    <span class="text-sm text-gray-500" x-text="`${e.processed}/${e.total}`"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-blue-500 h-3 rounded-full transition-all duration-300"
                         :style="`width: ${(e.total ? (e.processed/e.total)*100 : 0)}%`"></div>
                </div>
            </div>
        </template>
    </div>
    <script>
        document.addEventListener('alpine:init', () => {
            window.Alpine.store('events', []);
        });
        const evtSource = new EventSource("/events");
        evtSource.onmessage = (e) => {
            const data = JSON.parse(e.data);
            // Replace or add event for the table
            const events = window.Alpine.store('events');
            const idx = events.findIndex(ev => ev.table === data.table);
            if (idx !== -1) {
                events[idx] = data;
            } else {
                events.push(data);
            }
            window.Alpine.store('events', [...events]);
        };
    </script>
</body>
</html>
